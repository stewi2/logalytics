#!/usr/bin/env ruby

require 'rubygems'
require 'json'
require 'date'
require 'java'
require 'yaml'

config = YAML.load_file(File.expand_path('./config/hive.yml'))['hive']

url = "jdbc:hive2://#{config['host']}:#{config[:'port']}/#{config['database']}"

Dir['./lib/hive/**/*.jar'].each { |f| require File.join(f) }

java_import java.sql.DriverManager
DriverManager.register_driver(org.apache.hive.jdbc.HiveDriver.new)

conn = DriverManager.get_connection(url, config['username'], config['password'])
stmt = conn.create_statement if conn

puts "Adding missing partitions to Hive"

config['tables'].each do |table_name|
  query = "MSCK REPAIR TABLE #{table_name}"
  puts query
  stmt.execute_update(query)
end

stmt.close if stmt
stmt = nil
conn.close if conn
conn = nil
